@model List<SolicitudCompletaResponse>

@{
    ViewBag.Title = "Solicitudes";
    ViewBag.pTitle = "Listado de solicitudes";
    ViewBag.pageTitle = "Solicitudes";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var successMessage = TempData["SuccessMessage"] as string;
    var errorMessage = TempData["ErrorMessage"] as string;
}

@section styles {
    <!-- Datatable CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css" />
    <!-- Datatable Responsive CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.2.9/css/responsive.bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.2.2/css/buttons.dataTables.min.css">
}

<div class="row">
    <div class="col-lg-12">
        <div class="card">
            <a href="@Url.Action("RegistrarSolicitudFianza", "Solicitud")" class="btn btn-sm btn-info">
                Crear Solicitud
            </a>
            <h2>Gestión de Solicitud</h2>
            <div class="card-body">
                <table id="alternative-pagination" class="table table-bordered dt-responsive nowrap table-striped align-middle" style="width:100%">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Beneficiario</th>
                            <th>Tipo de Fianza</th>
                            <th>Monto</th>
                            <th>Estado</th>
                            <th>Observación</th>
                            <th>Acción</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var solicitud in Model)
                        {
                            <tr>
                                <td>@solicitud.SfId</td>
                                <td>@(solicitud.BeneficiarioNombre ?? "No definido")</td>
                                <td>@(solicitud.TipoSolicitudNombre ?? "Sin datos")</td>
                                <td>@String.Format("{0:C}", solicitud.SfMontoFianza)</td>
                                <td>
                                    @switch (solicitud.SfEstfId)
                                    {
                                        case 1:
                                            <span class="badge bg-warning">En espera de aprobación</span>
                                            break;
                                        case 2:
                                            <span class="badge bg-info">Aprobada sin documentación</span>
                                            break;
                                        case 3:
                                            <span class="badge bg-success">Aprobada y documentada</span>
                                            break;
                                        case 4:
                                            <span class="badge bg-success">Liberada</span>
                                            break;
                                        case 5:
                                            <span class="badge bg-danger">Rechazada</span>
                                            break;
                                        default:
                                            <span class="badge bg-secondary">Sin estado</span>
                                            break;
                                    }
                                </td>
                                <td>@(string.IsNullOrEmpty(solicitud.SfhObservacion) ? "Sin observaciones" : solicitud.SfhObservacion)</td>
                                <td>
                                    @if (solicitud.SfEstfId == 2 || solicitud.SfEstfId == 3)
                                    {
                                        <!-- Guardamos el valor de SfTposId en un input oculto -->
                                        <input type="hidden" class="hidden-tpos" value="@solicitud.SfTposId" />
                                        <button class="btn btn-primary btn-sm"
                                                data-bs-toggle="modal"
                                                data-bs-target="#gestionDocumentosModal"
                                                onclick="abrirModal(@(solicitud.SfId), @(solicitud.SfEstfId), @(solicitud.SfMontoFianza), this)">
                                            Gestión Documentos
                                        </button>
                                    }
                                    else if (solicitud.SfEstfId == 5)
                                    {
                                        <a class="btn btn-secondary btn-sm"
                                           href="@Url.Action("EditarSolicitudFianza", "Solicitud", new { id = solicitud.SfId })">
                                            Revisar
                                        </a>
                                    }
                                    else
                                    {
                                        <button class="btn btn-secondary btn-sm" disabled>Sin acción</button>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Gestión de Documentos -->
<div class="modal fade" id="gestionDocumentosModal" tabindex="-1" aria-labelledby="gestionDocumentosModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="gestionDocumentosModalLabel">Gestión de Documentos</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <!-- Formulario para subir documentos firmados -->
                <form id="uploadDocumentsForm" method="post" enctype="multipart/form-data" action="@Url.Action("InsertSfd", "Document")">
                    <div id="modalContent">
                        <!-- Se inyecta el contenido dinámico vía JavaScript -->
                    </div>
                    <!-- Campo oculto para identificar la solicitud -->
                    <input type="hidden" id="sfdId" name="sfdId" value="" />
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="submit" form="uploadDocumentsForm" class="btn btn-primary">Guardar cambios</button>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"
            integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
            crossorigin="anonymous"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.2.9/js/dataTables.responsive.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.2.2/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.print.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.html5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <script src="~/assets/js/pages/datatables.init.js"></script>

    @if (!string.IsNullOrEmpty(successMessage))
    {
        <script>
            Swal.fire({
                title: '¡Éxito!',
                text: '@successMessage',
                icon: 'success',
                confirmButtonText: 'OK',
                timer: 3000
            });
        </script>
    }

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <script>
            Swal.fire({
                title: 'Error',
                text: '@errorMessage',
                icon: 'error',
                confirmButtonText: 'OK',
                timer: 3000
            });
        </script>
    }

    <script>
        function abrirModal(sfdId, estfId, montoFianza, btn) {
            // Obtener el valor de SfTposId desde el input oculto de la celda
            var $td = $(btn).closest('td');
            var tposid = $td.find('input.hidden-tpos').val();
            // Establecer el id de la solicitud en el input oculto del formulario
            $('#sfdId').val(sfdId);

            // Definir los nombres de documentos y el tipo de firma según tposid
            var documentNames = [];
            var firmaTipo = "";
            switch (parseInt(tposid)) {
                case 1: // Fiel Cumplimiento del Contrato
                    documentNames = ['Solicitud Contrato', 'Convenio Contrato', 'Pagaré Contrato', 'Prenda Contrato'];
                    firmaTipo = "Firma Digital";
                    break;
                case 2: // Garantía Aduanera
                    documentNames = ['Solicitud Aduanera', 'Convenio Aduanera', 'Pagaré Aduanera', 'Garantía Aduanera'];
                    firmaTipo = "Firma Manual";
                    break;
                case 3: // Buen Uso del Anticipo
                    documentNames = ['Solicitud Anticipo', 'Convenio Anticipo', 'Pagaré Anticipo', 'Buen Uso Anticipo'];
                    firmaTipo = "Firma Digital";
                    break;
                default:
                    documentNames = ['Solicitud', 'Convenio', 'Pagaré', 'Prenda'];
                    firmaTipo = "Firma Manual";
                    break;
            }

            // Se utiliza Url.Action para crear el template de la URL de descarga.
            // Este template apuntará a la acción Download del controlador Documentos, la cual se encargará de retornar el PDF.
            var downloadUrlTemplate = '@Url.Action("Download", "Document", new { id = "DOCUMENT_ID" })';
            var montoFormateado = montoFianza.toLocaleString('es-ES', { style: 'currency', currency: 'USD' });
            var modalHtml = "";
            modalHtml += "<p>Monto de fianza: " + montoFormateado + "</p>";

            // Sección: Documentos Disponibles para descargar
            modalHtml += "<h6>Documentos Disponibles:</h6>";
            var numDocumentos = (montoFianza > 416000) ? 4 : 3;
            for (var i = 0; i < numDocumentos; i++) {
                var urlDescarga = downloadUrlTemplate.replace("DOCUMENT_ID", (i + 1));
                modalHtml += '<p><a href="' + urlDescarga + '" target="_blank">' + documentNames[i] + '</a></p>';
            }

            // Sección: Selección del tipo de firma
            modalHtml += "<h6>Selecciona el tipo de firma:</h6>";
            modalHtml += '<div class="form-check form-check-inline">';
            modalHtml += '<input class="form-check-input" type="radio" name="firmaTipo" id="firmaDigital" value="Firma Digital" ' + (firmaTipo === "Firma Digital" ? "checked" : "") + '>';
            modalHtml += '<label class="form-check-label" for="firmaDigital">Firma Digital</label>';
            modalHtml += '</div>';
            modalHtml += '<div class="form-check form-check-inline">';
            modalHtml += '<input class="form-check-input" type="radio" name="firmaTipo" id="firmaManual" value="Firma Manual" ' + (firmaTipo === "Firma Manual" ? "checked" : "") + '>';
            modalHtml += '<label class="form-check-label" for="firmaManual">Firma Manual</label>';
            modalHtml += '</div>';

            // Sección: Subir Documentos Firmados
            modalHtml += "<h6>Subir Documentos Firmados:</h6>";
            for (var j = 0; j < numDocumentos; j++) {
                modalHtml += '<div class="mb-3">';
                modalHtml += '<label for="fileInput' + (j + 1) + '">Documento ' + (j + 1) + ' (' + documentNames[j] + ')</label>';
                modalHtml += '<input type="file" id="fileInput' + (j + 1) + '" name="documento' + (j + 1) + '" class="form-control" />';
                modalHtml += '</div>';
            }

            $("#modalContent").html(modalHtml);
        }

        // Al cerrar el modal, eliminamos la clase "modal-open" y el backdrop para evitar interferencias visuales
        $('#gestionDocumentosModal').on('hidden.bs.modal', function () {
            $('body').removeClass('modal-open');
            $('.modal-backdrop').remove();
        });
    </script>
}
